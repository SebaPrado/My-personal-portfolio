<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alusur - Presupuesto de Ventanas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --color-steel-blue: rgb(70, 130, 180);
            --color-dark-navy: #1e2b3d;
            --color-slate: #436175;
            --color-ocean: #295d8a;
            --color-gray: #b1b6b7;
            
            /* Variantes con transparencia */
            --color-steel-blue-50: rgba(70, 130, 180, 0.5);
            --color-dark-navy-80: rgba(30, 43, 61, 0.8);
            --color-slate-30: rgba(67, 97, 117, 0.3);
            --color-ocean-60: rgba(41, 93, 138, 0.6);
        }  

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 300;
            background: linear-gradient(135deg, #141c26 0%, var(--color-dark-navy) 50%, #243447 100%);
            min-height: 100vh;
            padding: 30px 20px;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 8px;
            background: linear-gradient(90deg, #00d9ff, #e94560);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--color-gray);
            font-size: 1.1rem;
        }

        /* Botón añadir ventana */
        .btn-add-item {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 400;
            color: #fff;
            background: linear-gradient(135deg, var(--color-steel-blue), var(--color-ocean));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(70, 130, 180, 0.3);
            margin-bottom: 30px;
        }

        .btn-add-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(70, 130, 180, 0.5);
        }

        .btn-add-item svg {
            width: 20px;
            height: 20px;
        }

        /* Items container */
        #items-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* Cada item (ventana) */
        .item-card {
            background: rgba(30, 43, 61, 0.5);
            border: 1px solid var(--color-slate);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 25px;
            background: linear-gradient(90deg, rgba(67, 97, 117, 0.3), rgba(41, 93, 138, 0.2));
            border-bottom: 1px solid var(--color-slate);
            cursor: pointer;
            user-select: none;
        }

        .item-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        /* Botón expandir/contraer */
        .btn-toggle {
            background: var(--color-slate);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-toggle:hover {
            background: var(--color-ocean);
        }

        .btn-toggle svg {
            width: 18px;
            height: 18px;
            color: #fff;
            transition: transform 0.3s ease;
        }

        .btn-toggle.collapsed svg {
            transform: rotate(-90deg);
        }

        .item-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--color-ocean), var(--color-steel-blue));
            border-radius: 10px;
            font-weight: 400;
            font-size: 1.1rem;
            position: relative;
        }

        /* Alerta de categoría faltante */
        .alert-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #ffa500;
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: 400;
            display: none;
            align-items: center;
            justify-content: center;
            color: #000;
            box-shadow: 0 2px 8px rgba(255, 165, 0, 0.5);
            cursor: help;
        }

        .alert-badge.show {
            display: flex;
        }

        /* Tooltip para alerta */
        .alert-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-dark-navy);
            color: #ffa500;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 100;
            margin-top: 8px;
            font-weight: 300;
            border: 1px solid var(--color-slate);
        }

        .alert-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: var(--color-dark-navy);
        }

        .item-number:hover .alert-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .item-name-input {
            flex: 1;
            padding: 10px 15px;
            font-size: 1.1rem;
            font-weight: 400;
            background: rgba(30, 43, 61, 0.6);
            border: 2px solid var(--color-slate);
            border-radius: 8px;
            color: #fff;
            max-width: 300px;
        }

        .item-name-input:focus {
            outline: none;
            border-color: var(--color-steel-blue);
        }

        .item-name-input::placeholder {
            color: var(--color-gray);
        }

        /* Cantidad de ventanas */
        .item-qty-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 15px;
        }

        .item-qty-label {
            font-size: 0.85rem;
            color: var(--color-gray);
        }

        .item-qty-input {
            width: 60px;
            padding: 8px 10px;
            font-size: 1rem;
            font-weight: 400;
            text-align: center;
            background: rgba(30, 43, 61, 0.6);
            border: 2px solid var(--color-steel-blue);
            border-radius: 8px;
            color: var(--color-steel-blue);
        }

        .item-qty-input:focus {
            outline: none;
            border-color: var(--color-steel-blue);
            box-shadow: 0 0 8px rgba(70, 130, 180, 0.4);
        }

        .item-total {
            text-align: right;
            margin-left: 20px;
        }

        .item-total-label {
            font-size: 0.85rem;
            color: var(--color-gray);
        }

        .item-total-value {
            font-size: 1.5rem;
            font-weight: 400;
            color: var(--color-steel-blue);
        }

        .item-unit-price {
            font-size: 0.8rem;
            color: var(--color-gray);
        }

        .btn-delete-item {
            background: rgba(180, 70, 70, 0.2);
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 15px;
        }

        .btn-delete-item:hover {
            background: rgba(180, 70, 70, 0.4);
        }

        .btn-delete-item svg {
            width: 20px;
            height: 20px;
            color: #c0392b;
        }

        /* Sub-items con animación de collapse */
        .subitems-container {
            padding: 20px 25px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .subitems-container.collapsed {
            max-height: 0;
            padding: 0 25px;
            opacity: 0;
        }

        .subitem-row {
            display: grid;
            grid-template-columns: 150px 1fr 100px 120px 120px 50px;
            gap: 12px;
            align-items: center;
            padding: 12px 15px;
            background: rgba(30, 43, 61, 0.3);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(67, 97, 117, 0.3);
        }

        .subitem-row:hover {
            background: rgba(67, 97, 117, 0.2);
        }

        .subitem-select, .subitem-input {
            padding: 10px 12px;
            font-size: 0.9rem;
            background: rgba(30, 43, 61, 0.6);
            border: 1px solid var(--color-slate);
            border-radius: 8px;
            color: #fff;
            width: 100%;
        }

        .subitem-select:focus, .subitem-input:focus {
            outline: none;
            border-color: var(--color-steel-blue);
        }

        .subitem-select option {
            background: var(--color-dark-navy);
            color: #fff;
        }

        .subitem-input[type="number"] {
            text-align: center;
        }

        .subitem-price {
            text-align: right;
            font-size: 0.9rem;
            color: var(--color-gray);
        }

        .subitem-subtotal {
            text-align: right;
            font-weight: 400;
            color: var(--color-steel-blue);
            font-size: 1rem;
        }

        .btn-delete-subitem {
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.3s ease;
            padding: 5px;
        }

        .btn-delete-subitem:hover {
            opacity: 1;
        }

        .btn-delete-subitem svg {
            width: 18px;
            height: 18px;
            color: #c0392b;
        }

        /* Contenedor de acciones (añadir + duplicar) */
        .subitems-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        /* Botón añadir sub-item */
        .btn-add-subitem {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            font-size: 0.9rem;
            color: var(--color-steel-blue);
            background: rgba(70, 130, 180, 0.1);
            border: 1px dashed rgba(70, 130, 180, 0.5);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-add-subitem:hover {
            background: rgba(70, 130, 180, 0.2);
            border-color: var(--color-steel-blue);
        }

        .btn-add-subitem svg {
            width: 16px;
            height: 16px;
        }

        /* Link duplicar - minimalista */
        .btn-duplicate {
            background: none;
            border: none;
            color: var(--color-gray);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 8px 12px;
            opacity: 0.6;
            transition: all 0.2s ease;
        }

        .btn-duplicate:hover {
            opacity: 1;
            color: var(--color-steel-blue);
            text-decoration: underline;
        }

        /* Headers de sub-items */
        .subitems-header {
            display: grid;
            grid-template-columns: 150px 1fr 100px 120px 120px 50px;
            gap: 12px;
            padding: 10px 15px;
            font-size: 0.8rem;
            color: var(--color-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--color-slate);
            margin-bottom: 10px;
        }

        /* Total general */
        .grand-total {
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(70, 130, 180, 0.15), rgba(41, 93, 138, 0.15));
            border: 2px solid var(--color-steel-blue);
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grand-total-label {
            font-size: 1.3rem;
            color: #fff;
        }

        .grand-total-value {
            font-size: 2.5rem;
            font-weight: 400;
            color: var(--color-steel-blue);
            text-shadow: 0 0 20px rgba(70, 130, 180, 0.5);
        }

        /* Botones de acción */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .btn-download {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 35px;
            font-size: 1rem;
            font-weight: 400;
            color: #fff;
            background: linear-gradient(135deg, var(--color-ocean), var(--color-steel-blue));
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(41, 93, 138, 0.4);
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(70, 130, 180, 0.5);
        }

        .btn-download svg {
            width: 20px;
            height: 20px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-slate);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .subitem-row, .subitems-header {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .subitems-header {
                display: none;
            }

            .subitem-row > * {
                min-width: 0;
            }

            .item-header {
                flex-wrap: wrap;
                gap: 15px;
            }

            .item-header-left {
                width: 100%;
            }

            .item-qty-container {
                margin-left: 0;
            }
        }

        /* Para PDF */
        .pdf-value {
            display: none;
        }

        @media print {
            .btn-add-item, .btn-add-subitem, .btn-delete-item, .btn-delete-subitem, .action-buttons, .btn-toggle {
                display: none !important;
            }
            .subitem-select, .subitem-input, .item-name-input, .item-qty-input {
                display: none !important;
            }
            .pdf-value {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="../../public/logoAlusur.png" alt="Alusur Logo" style="height: 70px; margin-bottom: 8px;">
            <p class="subtitle">Soluciones innovadoras en aluminio y vidrio</p>
        </header>

        <button class="btn-add-item" onclick="addItem()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Añadir Ventana
        </button>

        <div id="items-container">
            <div class="empty-state" id="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                <p>No hay ventanas en el presupuesto.<br>Hacé clic en "Añadir Ventana" para comenzar.</p>
            </div>
        </div>

        <div class="grand-total" id="grand-total" style="display: none;">
            <span class="grand-total-label">TOTAL PRESUPUESTO:</span>
            <span class="grand-total-value" id="grand-total-value">$0</span>
        </div>

        <div class="action-buttons" id="action-buttons" style="display: none;">
            <button class="btn-download" onclick="downloadPDF()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Descargar PDF
            </button>
        </div>
    </div>

    <script>
        // Datos embebidos directamente (evita problemas de CORS al abrir desde file://)
        
        const perfilesData = [
            { id: "201", nombre: "Perfil 201", descripcion: "Marco perimetral liviano", unidad: "metro", kg_mt: 0.35, precio: 2800 },
            { id: "202", nombre: "Perfil 202", descripcion: "Hoja de ventana estándar", unidad: "metro", kg_mt: 0.42, precio: 3200 },
            { id: "204", nombre: "Perfil 204", descripcion: "Jamba lateral reforzada", unidad: "metro", kg_mt: 0.55, precio: 3800 },
            { id: "205", nombre: "Perfil 205", descripcion: "Travesaño horizontal", unidad: "metro", kg_mt: 0.48, precio: 3500 },
            { id: "210", nombre: "Perfil 210", descripcion: "Riel inferior corredizo", unidad: "metro", kg_mt: 0.68, precio: 4200 },
            { id: "2501", nombre: "Perfil 2501", descripcion: "Marco perimetral pesado", unidad: "metro", kg_mt: 0.85, precio: 5200 },
            { id: "2502", nombre: "Perfil 2502", descripcion: "Hoja de puerta corrediza", unidad: "metro", kg_mt: 1.10, precio: 6400 },
            { id: "2504", nombre: "Perfil 2504", descripcion: "Jamba de puerta reforzada", unidad: "metro", kg_mt: 1.35, precio: 7200 },
            { id: "2505", nombre: "Perfil 2505", descripcion: "Travesaño estructural", unidad: "metro", kg_mt: 1.20, precio: 6800 },
            { id: "2510", nombre: "Perfil 2510", descripcion: "Riel inferior puerta pesada", unidad: "metro", kg_mt: 1.55, precio: 8500 }
        ];

        const vidriosData = [
            // Simple
            { id: "simple_2mm", nombre: "Vidrio Simple 2mm", categoria: "simple", grosor: "2mm", unidad: "m3", precio: 4500 },
            { id: "simple_3mm", nombre: "Vidrio Simple 3mm", categoria: "simple", grosor: "3mm", unidad: "m2", precio: 5200 },
            { id: "simple_4mm", nombre: "Vidrio Simple 4mm", categoria: "simple", grosor: "4mm", unidad: "m2", precio: 6100 },
            { id: "simple_5mm", nombre: "Vidrio Simple 5mm", categoria: "simple", grosor: "5mm", unidad: "m2", precio: 7200 },
            { id: "simple_6mm", nombre: "Vidrio Simple 6mm", categoria: "simple", grosor: "6mm", unidad: "m2", precio: 8500 },
            { id: "simple_8mm", nombre: "Vidrio Simple 8mm", categoria: "simple", grosor: "8mm", unidad: "m2", precio: 10800 },
            { id: "simple_10mm", nombre: "Vidrio Simple 10mm", categoria: "simple", grosor: "10mm", unidad: "m2", precio: 13500 },
            // Doble
            { id: "doble_2+2", nombre: "DVH 2+2mm", categoria: "doble", grosor: "2+2", unidad: "m2", precio: 12000 },
            { id: "doble_3+3", nombre: "DVH 3+3mm", categoria: "doble", grosor: "3+3", unidad: "m2", precio: 14200 },
            { id: "doble_4+4", nombre: "DVH 4+4mm", categoria: "doble", grosor: "4+4", unidad: "m2", precio: 16800 },
            { id: "doble_5+5", nombre: "DVH 5+5mm", categoria: "doble", grosor: "5+5", unidad: "m2", precio: 19500 },
            { id: "doble_6+6", nombre: "DVH 6+6mm", categoria: "doble", grosor: "6+6", unidad: "m2", precio: 23000 },
            { id: "doble_8+8", nombre: "DVH 8+8mm", categoria: "doble", grosor: "8+8", unidad: "m2", precio: 28500 },
            { id: "doble_10+10", nombre: "DVH 10+10mm", categoria: "doble", grosor: "10+10", unidad: "m2", precio: 35000 },
            // Templado
            { id: "templado_2mm", nombre: "Vidrio Templado 2mm", categoria: "templado", grosor: "2mm", unidad: "m2", precio: 8500 },
            { id: "templado_3mm", nombre: "Vidrio Templado 3mm", categoria: "templado", grosor: "3mm", unidad: "m2", precio: 9800 },
            { id: "templado_4mm", nombre: "Vidrio Templado 4mm", categoria: "templado", grosor: "4mm", unidad: "m2", precio: 11500 },
            { id: "templado_5mm", nombre: "Vidrio Templado 5mm", categoria: "templado", grosor: "5mm", unidad: "m2", precio: 13500 },
            { id: "templado_6mm", nombre: "Vidrio Templado 6mm", categoria: "templado", grosor: "6mm", unidad: "m2", precio: 16000 },
            { id: "templado_8mm", nombre: "Vidrio Templado 8mm", categoria: "templado", grosor: "8mm", unidad: "m2", precio: 20500 },
            { id: "templado_10mm", nombre: "Vidrio Templado 10mm", categoria: "templado", grosor: "10mm", unidad: "m2", precio: 25500 }
        ];

        const accesoriosData = [
            { id: "felpa", nombre: "Felpa", descripcion: "Felpa de sellado para ventanas", unidad: "metro", precio: 850 },
            { id: "angulo", nombre: "Ángulo", descripcion: "Ángulo de unión para perfiles", unidad: "unidad", precio: 1200 },
            { id: "rueda_corrediza1", nombre: "Rueda Corrediza 1", descripcion: "Rueda corrediza simple - carga liviana", unidad: "par", precio: 2500 },
            { id: "rueda_corrediza2", nombre: "Rueda Corrediza 2", descripcion: "Rueda corrediza reforzada - carga media", unidad: "par", precio: 3800 },
            { id: "rueda_corrediza3", nombre: "Rueda Corrediza 3", descripcion: "Rueda corrediza premium - carga pesada", unidad: "par", precio: 5200 },
            { id: "manijas", nombre: "Manijas", descripcion: "Manija estándar para ventana/puerta", unidad: "unidad", precio: 4500 },
            { id: "cierres", nombre: "Cierres", descripcion: "Cierre de seguridad para abertura", unidad: "unidad", precio: 3200 },
            { id: "anclajes", nombre: "Anclajes", descripcion: "Anclaje de fijación a muro", unidad: "unidad", precio: 950 },
            { id: "burlete1", nombre: "Burlete 1", descripcion: "Burlete de goma estándar", unidad: "metro", precio: 650 },
            { id: "burlete2", nombre: "Burlete 2", descripcion: "Burlete de EPDM reforzado", unidad: "metro", precio: 980 },
            { id: "burlete3", nombre: "Burlete 3", descripcion: "Burlete premium hermético", unidad: "metro", precio: 1350 }
        ];

        let itemCounter = 0;

        // Añadir item (ventana)
        function addItem() {
            itemCounter++;
            const container = document.getElementById('items-container');
            const emptyState = document.getElementById('empty-state');
            
            if (emptyState) emptyState.style.display = 'none';
            document.getElementById('grand-total').style.display = 'flex';
            document.getElementById('action-buttons').style.display = 'flex';

            const itemHTML = `
                <div class="item-card" id="item-${itemCounter}" data-item-id="${itemCounter}">
                    <div class="item-header" onclick="toggleItem(event, ${itemCounter})">
                        <div class="item-header-left">
                            <button class="btn-toggle" id="btn-toggle-${itemCounter}" onclick="event.stopPropagation(); toggleItem(event, ${itemCounter})">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div class="item-number">
                                ${itemCounter}
                                <div class="alert-badge" id="alert-${itemCounter}">!</div>
                                <div class="alert-tooltip" id="alert-tooltip-${itemCounter}"></div>
                            </div>
                            <input type="text" class="item-name-input" placeholder="Nombre de la ventana..." value="Ventana ${itemCounter}" onclick="event.stopPropagation()">
                        </div>
                        <div class="item-qty-container" onclick="event.stopPropagation()">
                            <span class="item-qty-label">Cant:</span>
                            <input type="number" class="item-qty-input" id="qty-${itemCounter}" value="1" min="1" step="1" onchange="updateItemTotal(${itemCounter})" oninput="updateItemTotal(${itemCounter})">
                        </div>
                        <div class="item-total">
                            <div class="item-total-label">Total</div>
                            <div class="item-total-value" id="item-total-${itemCounter}">$0</div>
                            <div class="item-unit-price" id="item-unit-${itemCounter}">Unitario: $0</div>
                        </div>
                        <button class="btn-delete-item" onclick="event.stopPropagation(); deleteItem(${itemCounter})">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    <div class="subitems-container" id="subitems-container-${itemCounter}">
                        <div class="subitems-header">
                            <div>Categoría</div>
                            <div>Producto</div>
                            <div>Cantidad</div>
                            <div>Precio Unit.</div>
                            <div>Subtotal</div>
                            <div></div>
                        </div>
                        <div class="subitems-list" id="subitems-${itemCounter}">
                        </div>
                        <div class="subitems-actions">
                            <button class="btn-add-subitem" onclick="addSubitem(${itemCounter})">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Añadir componente
                            </button>
                            <button class="btn-duplicate" onclick="duplicateItem(${itemCounter})">
                                Duplicar ventana
                            </button>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', itemHTML);
            checkItemCategories(itemCounter);
            updateGrandTotal();
        }

        // Toggle expandir/contraer
        function toggleItem(event, itemId) {
            const container = document.getElementById(`subitems-container-${itemId}`);
            const btn = document.getElementById(`btn-toggle-${itemId}`);
            
            container.classList.toggle('collapsed');
            btn.classList.toggle('collapsed');
        }

        // Eliminar item
        function deleteItem(itemId) {
            const item = document.getElementById(`item-${itemId}`);
            if (item) {
                item.remove();
                updateGrandTotal();
                
                // Mostrar empty state si no hay items
                const items = document.querySelectorAll('.item-card');
                if (items.length === 0) {
                    document.getElementById('empty-state').style.display = 'block';
                    document.getElementById('grand-total').style.display = 'none';
                    document.getElementById('action-buttons').style.display = 'none';
                }
            }
        }

        // Duplicar item (ventana completa con todos sus sub-items)
        function duplicateItem(sourceItemId) {
            // Obtener datos del item original
            const sourceItem = document.getElementById(`item-${sourceItemId}`);
            if (!sourceItem) return;

            // Obtener el nombre de la ventana original
            const sourceName = sourceItem.querySelector('.item-name-input').value;
            const sourceQty = document.getElementById(`qty-${sourceItemId}`).value;
            
            // Obtener todos los sub-items con sus datos
            const sourceSubitems = sourceItem.querySelectorAll('.subitem-row');
            const subitemsData = [];
            
            sourceSubitems.forEach(subitem => {
                const categoriaSelect = subitem.querySelector('.categoria-select');
                const productoSelect = subitem.querySelector('.producto-select');
                const cantidadInput = subitem.querySelector('.cantidad-input');
                
                subitemsData.push({
                    categoria: categoriaSelect.value,
                    producto: productoSelect.value,
                    cantidad: cantidadInput.value
                });
            });

            // Crear nuevo item
            addItem();
            const newItemId = itemCounter;
            
            // Copiar nombre (con indicador de copia)
            const newNameInput = document.querySelector(`#item-${newItemId} .item-name-input`);
            newNameInput.value = `${sourceName} (copia)`;
            
            // Copiar cantidad
            document.getElementById(`qty-${newItemId}`).value = sourceQty;

            // Recrear cada sub-item
            subitemsData.forEach(data => {
                if (data.categoria) {
                    addSubitem(newItemId);
                    const newSubitemId = subitemCounter;
                    
                    // Setear categoría
                    const catSelect = document.getElementById(`categoria-${newSubitemId}`);
                    catSelect.value = data.categoria;
                    onCategoriaChange(newSubitemId, data.categoria, newItemId);
                    
                    // Setear producto (después de que se carguen las opciones)
                    setTimeout(() => {
                        const prodSelect = document.getElementById(`producto-${newSubitemId}`);
                        prodSelect.value = data.producto;
                        onProductoChange(newSubitemId);
                        
                        // Setear cantidad
                        document.getElementById(`cantidad-${newSubitemId}`).value = data.cantidad;
                        updateSubitemTotal(newSubitemId);
                    }, 10);
                }
            });

            // Actualizar totales después de un pequeño delay
            setTimeout(() => {
                updateItemTotal(newItemId);
                checkItemCategories(newItemId);
                updateGrandTotal();
            }, 100);
        }

        // Añadir subitem
        let subitemCounter = 0;
        function addSubitem(itemId) {
            subitemCounter++;
            const container = document.getElementById(`subitems-${itemId}`);

            const subitemHTML = `
                <div class="subitem-row" id="subitem-${subitemCounter}" data-item-id="${itemId}">
                    <select class="subitem-select categoria-select" id="categoria-${subitemCounter}" onchange="onCategoriaChange(${subitemCounter}, this.value, ${itemId})">
                        <option value="">Categoría...</option>
                        <option value="perfil">Perfil</option>
                        <option value="vidrio">Vidrio</option>
                        <option value="accesorio">Accesorio</option>
                    </select>
                    <select class="subitem-select producto-select" id="producto-${subitemCounter}" onchange="onProductoChange(${subitemCounter})" disabled>
                        <option value="">Seleccionar producto...</option>
                    </select>
                    <input type="number" class="subitem-input cantidad-input" id="cantidad-${subitemCounter}" value="1" min="0.01" step="0.01" onchange="updateSubitemTotal(${subitemCounter})" oninput="updateSubitemTotal(${subitemCounter})">
                    <div class="subitem-price" id="precio-${subitemCounter}">$0</div>
                    <div class="subitem-subtotal" id="subtotal-${subitemCounter}">$0</div>
                    <button class="btn-delete-subitem" onclick="deleteSubitem(${subitemCounter}, ${itemId})">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', subitemHTML);
            checkItemCategories(itemId);
        }

        // Eliminar subitem
        function deleteSubitem(subitemId, itemId) {
            const subitem = document.getElementById(`subitem-${subitemId}`);
            if (subitem) {
                subitem.remove();
                updateItemTotal(itemId);
                checkItemCategories(itemId);
                updateGrandTotal();
            }
        }

        // Cambio de categoría
        function onCategoriaChange(subitemId, categoria, itemId) {
            const productoSelect = document.getElementById(`producto-${subitemId}`);
            productoSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
            productoSelect.disabled = false;

            let options = [];
            
            if (categoria === 'perfil') {
                options = perfilesData.map(p => ({
                    id: p.id,
                    nombre: `${p.nombre} - ${p.descripcion}`,
                    precio: p.precio,
                    unidad: p.unidad
                }));
            } else if (categoria === 'vidrio') {
                options = vidriosData.map(v => ({
                    id: v.id,
                    nombre: `${v.nombre} (${v.categoria})`,
                    precio: v.precio,
                    unidad: v.unidad
                }));
            } else if (categoria === 'accesorio') {
                options = accesoriosData.map(a => ({
                    id: a.id,
                    nombre: `${a.nombre} - ${a.descripcion}`,
                    precio: a.precio,
                    unidad: a.unidad
                }));
            }

            options.forEach(opt => {
                const optionEl = document.createElement('option');
                optionEl.value = JSON.stringify(opt);
                optionEl.textContent = `${opt.nombre} - $${opt.precio.toLocaleString()}/${opt.unidad}`;
                productoSelect.appendChild(optionEl);
            });

            // Reset valores
            document.getElementById(`precio-${subitemId}`).textContent = '$0';
            document.getElementById(`subtotal-${subitemId}`).textContent = '$0';
            
            // Verificar categorías faltantes
            checkItemCategories(itemId);
        }

        // Cambio de producto
        function onProductoChange(subitemId) {
            const productoSelect = document.getElementById(`producto-${subitemId}`);
            const precioEl = document.getElementById(`precio-${subitemId}`);
            
            if (productoSelect.value) {
                const producto = JSON.parse(productoSelect.value);
                precioEl.textContent = `$${producto.precio.toLocaleString()}`;
                precioEl.dataset.precio = producto.precio;
                updateSubitemTotal(subitemId);
            } else {
                precioEl.textContent = '$0';
                precioEl.dataset.precio = 0;
            }
        }

        // Actualizar total de subitem
        function updateSubitemTotal(subitemId) {
            const precioEl = document.getElementById(`precio-${subitemId}`);
            const cantidadEl = document.getElementById(`cantidad-${subitemId}`);
            const subtotalEl = document.getElementById(`subtotal-${subitemId}`);
            const subitemRow = document.getElementById(`subitem-${subitemId}`);
            
            const precio = parseFloat(precioEl.dataset.precio) || 0;
            const cantidad = parseFloat(cantidadEl.value) || 0;
            const subtotal = precio * cantidad;
            
            subtotalEl.textContent = `$${subtotal.toLocaleString()}`;
            subtotalEl.dataset.subtotal = subtotal;

            // Actualizar total del item padre
            const itemId = subitemRow.dataset.itemId;
            updateItemTotal(itemId);
            updateGrandTotal();
        }

        // Actualizar total del item (considerando cantidad de ventanas)
        function updateItemTotal(itemId) {
            const subitems = document.querySelectorAll(`#subitems-${itemId} .subitem-row`);
            let unitTotal = 0;
            
            subitems.forEach(subitem => {
                const subtotalEl = subitem.querySelector('.subitem-subtotal');
                unitTotal += parseFloat(subtotalEl.dataset.subtotal) || 0;
            });

            const qtyInput = document.getElementById(`qty-${itemId}`);
            const qty = parseInt(qtyInput.value) || 1;
            const total = unitTotal * qty;

            const totalEl = document.getElementById(`item-total-${itemId}`);
            const unitEl = document.getElementById(`item-unit-${itemId}`);
            
            if (totalEl) {
                totalEl.textContent = `$${total.toLocaleString()}`;
                totalEl.dataset.total = total;
            }
            if (unitEl) {
                unitEl.textContent = qty > 1 ? `Unitario: $${unitTotal.toLocaleString()}` : '';
            }
            
            updateGrandTotal();
        }

        // Verificar categorías faltantes en un item
        function checkItemCategories(itemId) {
            const subitems = document.querySelectorAll(`#subitems-${itemId} .subitem-row`);
            const categories = new Set();
            
            subitems.forEach(subitem => {
                const catSelect = subitem.querySelector('.categoria-select');
                if (catSelect && catSelect.value) {
                    categories.add(catSelect.value);
                }
            });

            const missing = [];
            if (!categories.has('vidrio')) missing.push('vidrio');
            if (!categories.has('perfil')) missing.push('perfiles');
            if (!categories.has('accesorio')) missing.push('accesorios');

            const alertBadge = document.getElementById(`alert-${itemId}`);
            const alertTooltip = document.getElementById(`alert-tooltip-${itemId}`);

            if (missing.length > 0 && missing.length < 3) {
                alertBadge.classList.add('show');
                alertTooltip.textContent = `⚠️ Falta: ${missing.join(', ')}`;
            } else {
                alertBadge.classList.remove('show');
                alertTooltip.textContent = '';
            }
        }

        // Actualizar total general
        function updateGrandTotal() {
            const itemTotals = document.querySelectorAll('.item-total-value');
            let grandTotal = 0;
            
            itemTotals.forEach(el => {
                grandTotal += parseFloat(el.dataset.total) || 0;
            });

            document.getElementById('grand-total-value').textContent = `$${grandTotal.toLocaleString()}`;
        }

        // Descargar PDF
        function downloadPDF() {
            // Expandir todos los items antes de generar PDF
            document.querySelectorAll('.subitems-container.collapsed').forEach(el => {
                el.classList.remove('collapsed');
            });
            document.querySelectorAll('.btn-toggle.collapsed').forEach(el => {
                el.classList.remove('collapsed');
            });

            const element = document.querySelector('.container');
            
            // Preparar para PDF - mostrar valores como texto
            const selects = document.querySelectorAll('.subitem-select');
            const inputs = document.querySelectorAll('.subitem-input, .item-name-input, .item-qty-input');
            
            selects.forEach(select => {
                const span = document.createElement('span');
                span.className = 'pdf-value';
                span.textContent = select.options[select.selectedIndex]?.text || '-';
                span.style.display = 'block';
                span.style.color = '#fff';
                select.style.display = 'none';
                select.parentNode.insertBefore(span, select.nextSibling);
            });


            inputs.forEach(input => {
                const span = document.createElement('span');
                span.className = 'pdf-value';
                span.textContent = input.value;
                span.style.display = 'block';
                span.style.color = '#fff';
                span.style.textAlign = input.type === 'number' ? 'center' : 'left';
                input.style.display = 'none';
                input.parentNode.insertBefore(span, input.nextSibling);
            });

            // Ocultar botones y alertas
            document.querySelectorAll('.btn-add-item, .btn-add-subitem, .btn-delete-item, .btn-delete-subitem, .action-buttons, .btn-toggle, .alert-badge').forEach(el => {
                el.dataset.originalDisplay = el.style.display;
                el.style.display = 'none';
            });

            const opt = {
                margin: 10,
                filename: 'Presupuesto_Alusur.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#1e2b3d'
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                // Restaurar
                document.querySelectorAll('.pdf-value').forEach(el => el.remove());
                selects.forEach(select => select.style.display = '');
                inputs.forEach(input => input.style.display = '');
                document.querySelectorAll('.btn-add-item, .btn-add-subitem, .btn-delete-item, .btn-delete-subitem, .action-buttons, .btn-toggle, .alert-badge').forEach(el => {
                    el.style.display = el.dataset.originalDisplay || '';
                });
            });
        }
    </script>
</body>
</htmlº